(function(a){a.widget("ui.inlinepreview",{options:{style:{type:"tabs",initialSelectedTab:null,autoSelectedPopup:null,popupButtons:true,useSlider:false,buttonAlignment:"left",processingImage:"images/processing.gif",buttonPanelRuleColor:"",width:400,height:400},previewWidth:"sizeof(#preview-container)",previewHeight:"sizeof(#preview-container)",fade:{speed:500,easing:"swing"},tabs:[{id:"preview",title:"Preview",href:"#tab=1"}],errorCodes:[{errorCode:"MESSAGE_POPUP",errorMessage:"Here is the requested preview."},{errorCode:"ERROR_IMAGELOAD",errorMessage:"There was an error loading the preview image."},{errorCode:"ERROR_ALREADYPROCESSING",errorMessage:"There is already a preview being generated."},{errorCode:"ERROR_CORRUPTPROJECT",errorMessage:"The project has been corrupted."},{errorCode:"ERROR_FONTNOTFOUND",errorMessage:"A required font was not found."},{errorCode:"ERROR_GLYPHMISSING",errorMessage:"There is a glyph missing."},{errorCode:"ERROR_HTMLGENERATION",errorMessage:"The HTML failed to generate."},{errorCode:"ERROR_INVALIDRESPONSE",errorMessage:"An invalid response was returned by the preview request script."},{errorCode:"ERROR_NODATA",errorMessage:"No preview data was returned."},{errorCode:"ERROR_PROCESSING",errorMessage:"There was an error processing the preview request data."},{errorCode:"ERROR_RASTERIZATION",errorMessage:"The rasterization process has failed."},{errorCode:"ERROR_REQUEST",errorMessage:"There was an error requesting the preview."},{errorCode:"ERROR_SCALING",errorMessage:"There was an error scaling the preview image."},{errorCode:"ERROR_TEXTOVERFLOW",errorMessage:"Your text has overflowed."},{errorCode:"ERROR_UNKNOWN",errorMessage:"An Unknown Error Occured."}],processingUrls:{inline:"",popup:""},formId:"",proccessIdQuerystringParamName:"PreviewRequestGUID"},_currentPreview:null,_guidInternalPreviewResponseGUID:"",_tabControl:null,_tabPanel:null,_previewContainer:null,_sliderControl:null,_buttonPanel:null,_popupButtonPanel:null,_messageDialog:null,previewImage:null,_create:function(){this._trigger("creatingInlinePreview",null,this);var j=this,k=j.options,d=j.element;d.empty();d.addClass("ui-widget ui-ip");j._previewContainer=a("<div></div>").attr("id","preview-container").html("&nbsp;").css({width:(a.type(k.style.width)==="string"?k.style.width:parseInt(k.style.width)+"px"),height:(a.type(k.style.height)==="string"?k.style.height:parseInt(k.style.height)+"px")});if(k.style.type.toLowerCase()!="simple"){var f=a("<div></div>").attr("id","ip-tabs");var g=a("<ul></ul>").appendTo(f);var c=k.tabs;if(k.style.type.toLowerCase()==="buttons"){c=[{id:"preview",title:"Preview",href:"#tab-1"}]}for(var e=0;e<c.length;e++){var b=a("<li></li>").appendTo(g);var h=a("<a></a>").attr("href","#tabs-1").attr("data-popup","false").attr("data-url",j._appendParams(k.style.type.toLowerCase()==="tabs"?k.processingUrls.inline:"",k.tabs[e].href)).addClass("ip-tab").text(c[e].title).appendTo(b)}j._tabPanel=a("<div></div>").addClass("previewBox").attr("id","tabs-1").appendTo(f);j._previewContainer.appendTo(f);f.appendTo(d);j._tabControl=f}else{j._previewContainer.appendTo(d)}if(k.style.useSlider){j._sliderControl=a("<div></div>").attr("id","ip-page-selector").appendTo(d)}if(k.style.type.toLowerCase()!="tabs"||k.style.popupButtons){if(k.style.type.toLowerCase()!="tabs"){if(k.style.buttonPanelRuleColor.length!=0){a("<hr />").css("color",k.style.buttonPanelRuleColor).css("background-color",k.style.buttonPanelRuleColor).appendTo(k.style.type.toLowerCase()!="simple"?j._tabControl:d)}j._buttonPanel=a("<div></div>").attr("id","inline-preview-buttonPanel").addClass("ip-btn-panel").appendTo(k.style.type.toLowerCase()!="simple"?j._tabControl:d);if(k.style.buttonAlignment.length!=0){j._buttonPanel.css("text-align",k.style.buttonAlignment)}}if(k.style.popupButtons){if(k.style.buttonPanelRuleColor.length!=0){a("<hr />").css("color",k.style.buttonPanelRuleColor).css("background-color",k.style.buttonPanelRuleColor).appendTo(k.style.type.toLowerCase()!="simple"?j._tabControl:d)}j._popupButtonPanel=a("<div></div>").attr("id","inline-preview-popupButtonPanel").addClass("ip-btn-panel").appendTo(k.style.type.toLowerCase()!="simple"?j._tabControl:d);if(k.style.buttonAlignment.length!=0){j._popupButtonPanel.css("text-align",k.style.buttonAlignment)}}for(var e=0;e<k.tabs.length;e++){if(k.style.type.toLowerCase()!="tabs"){j._appendButton(e,false,j._buttonPanel)}if(k.style.popupButtons){j._appendButton(e,true,j._popupButtonPanel)}}}j._messageDialog=a("<div></div>").attr("id","preview-dialog").attr("title","Preview Dialog").appendTo(d);this._trigger("createdInlinePreview",null,this)},_init:function(){this._trigger("initialisingInlinePreview",null,this);var c=this,d=c.options;c._messageDialog.dialog({autoOpen:false,resizable:false,heigth:d.style.height+25,width:d.style.width+25,draggable:false,modal:true,buttons:{OK:function(){a(this).dialog("close")}}});if(c._tabControl!=null){c._tabControl.tabs({selected:d.style.type.toLowerCase()!=="tabs"?0:-1,select:function(e,f){if(d.style.type.toLowerCase()==="tabs"){return c._requestPreview(f.index+1,f.tab)}return false}})}if(c._sliderControl!=null){c._sliderControl.slider({min:1,max:d.tabs.length,slide:function(e,f){c._trigger("selectingPage",null,f);if(d.style.type.toLowerCase()==="tabs"){c._tabControl.tabs("select",f.value-1)}else{c._requestPreview(f.value,a(this))}c._trigger("pageSelected",null,f)}})}if(d.style.initialSelectedTab!=null){var b=c._getTabIndex(d.style.initialSelectedTab);if(c._sliderControl!=null){c._sliderControl.slider("value",b)}switch(d.style.type){case"tabs":c._tabControl.tabs("select",b);break;default:b++;a("button:nth-child("+b+")",c._buttonPannel).click();break}}if(d.style.autoSelectedPopup!=null&&d.style.popupButtons){var b=c._getTabIndex(d.style.autoSelectedPopup)+1;a("button:nth-child("+b+")",c._popupButtonPanel).click()}this._trigger("initialisedInlinePreview",null,this)},_getTabIndex:function(b){if(b==null){return 1}var c=this,d=c.options;if(a.type(b)=="number"&&b<d.tabs.length){return b}for(var e=0;e<d.tabs.length;e++){if(d.tabs[e].id===b){return e}if(d.tabs[e].title===b){return e}}return 1},_getPreviewSize:function(e){var c=400,f=400,i=this,j=i.options;switch(e){case"width":c=j.previewWidth;f=j.style.width;break;case"height":c=j.previewHeight;f=j.style.height;break}if(a.type(c)==="string"){var g=c.indexOf("(");var b=c.indexOf(")");if(g!=-1&&b!=-1){var h=c.substring(0,g);var d=c.substring(g+1,b);switch(h){case"sizeof":c=parseInt(a(d).css(e));break;case"valueof":c=parseInt(a(d).val());break}}else{c=parseInt(c)}}return(a.type(c)!="number"||c==0?f:c)},_requestPreview:function(c,h){this._trigger("requestingPreview",null,this);var b=true,d=this,e=d.options;d._currentPreview=parseInt(c);var g=a(h).attr("data-url");if(d._parseBool(a(h).attr("data-popup"))){d._displayMessage(g,"","","",false)}else{if(d._guidInternalPreviewResponseGUID.length==0){d._previewContainer.addClass("loading").css("background-image","url("+e.style.processingImage+")");d._guidInternalPreviewResponseGUID=d._generateCustomGuid("IP",false,false);g=d._appendParam(g,e.proccessIdQuerystringParamName,d._guidInternalPreviewResponseGUID);if(d.previewImage!=null){d.previewImage.off("click.inline-previe-image")}d._previewContainer.find("img").animate({opacity:0},e.fade.speed,e.fade.easing);var f=a("form"+e.formId).serializeArray();a.ajax({type:"POST",data:f,contentType:"application/x-www-form-urlencoded",url:g,dataType:"json",cache:false,success:function(l,k,i){try{if(d._guidInternalPreviewResponseGUID==l.PreviewRequestGUID){switch(l.Status){case"Cancelled":window.location=l.CancelledURL;break;case"Preview":case"Error":case"Warning":if(l.PreviewImage.length!=0){d._embedPreviewImage(l.PreviewImage,l.PreviewLink)}else{if(l.PreviewLink.length!=0){d._displayMessage(l.PreviewLink,"","","",true)}else{d._displayMessage("","","ERROR_NODATA","",true)}}if(l.Status=="Error"||l.Status=="Warning"){var j=(l.Status==="Error"?"circle-close":"alert");d._displayMessage("",j,l.ErrorCode,"",true)}break;default:d._displayMessage("","","ERROR_INVALIDRESPONSE","",true);break}}}catch(m){d._displayMessage("","","ERROR_PROCESSING","",true)}},error:function(i,j,k){if(i.status!=0){d._displayMessage("","","ERROR_REQUEST","",true)}}})}else{d._displayMessage("","alert","ERROR_ALREADYPROCESSING","",false);b=false}}this._trigger("previewRequestedComplete",null,this);return b},_embedPreviewImage:function(f,e){this._trigger("embeddingScaledImage",null,this);var c=this,d=c.options;var b=new Image();a(b).load(function(){try{var h=c._getPreviewSize("width");var j=c._getPreviewSize("height");var g=b.width;var n=b.height;var l=(h/g);var o=(j/n);var i=l<o?l:o;if(i!=1){b.width=Math.round(g*i);b.height=Math.round(n*i)}}catch(m){c._displayMessage("","","ERROR_SCALING","",true)}c.previewImage=a('<img src="'+b.src+'" />').attr("alt","Preview Image").css("border","0").css("width",b.width).css("height",b.height).css("opacity","0");if(!a.support.opacity){var j=c._getPreviewSize("height");var k=Math.round((j-b.height)/2);c.previewImage.css("top",k)}c._previewContainer.empty();if(a.type(e)==="string"&&e.length!=0){c.previewImage.on("click.inline-previe-image",function(){c._displayMessage(e,"","","",false)})}c.previewImage.appendTo(c._previewContainer);c.previewImage.animate({opacity:1},d.fade.speed,d.fade.easing,function(){c._previewContainer.removeClass("loading").css("background-image","none");c._guidInternalPreviewResponseGUID=""})}).error(function(){c._displayMessage("","","ERROR_IMAGELOAD","",true)}).attr("src",f);this._trigger("embededScaledImage",null,this)},_displayMessage:function(h,e,g,k,c){var i=this,l=i.options;i._messageDialog.empty();var f=(h.length!=0?"Preview":(e=="circle-close"||e.length==0?"An Error Occured":"Warning"));if(h.length!=0){var b=a("<iframe></iframe>").attr("src",h).css({height:l.style.height,width:l.style.width}).appendTo(i._messageDialog)}else{var d=a("<span></span>").addClass("ui-icon ui-icon-"+(e.length!=0?e:"circle-close")).css({"float":"left",margin:"0 7px 50px 0"}).appendTo(i._messageDialog);var j=a("<p></p>").appendTo(i._messageDialog);if(g.length!=0){j.text(i._getErrorMessages(g))}else{if(k.length!=0){j.text(k)}}}if(c){i._previewContainer.removeClass("loading").css("background-image","none");i._guidInternalPreviewResponseGUID=""}i._messageDialog.attr("title",f).dialog("open")},_appendButton:function(f,e,c){var b=this,d=b.options;var h=d.tabs[f];var g=a("<button>").addClass("ip-btn").text(h.title).attr("data-popup",e?"true":"false").attr("data-url",b._appendParams(e?d.processingUrls.popup:d.processingUrls.inline,h.href)).appendTo(c).button().on("click.inline-preview-button",function(){if(a(this).attr("data-popup")==="false"){b._currentPreview=f}b._requestPreview(b._currentPreview,a(this))})},_getErrorMessages:function(f){var b=this,e=b.options.errorCodes;var c="";for(var d=0;d<e.length;d++){if(f.toUpperCase()===e[d].errorCode.toUpperCase()){c=e[d].errorMessage;break}}return c},_parseBool:function(b){return/^true$/.test(b.toLowerCase())},_generateCustomGuid:function(e,d,c){var b=this._generateGuid(false,c);b=e+b.substr(e.length);if(d){b="{"+b+"}"}return b},_generateGuid:function(d,c){var b=((d?"{":"")+"xxxxxxxx"+(c?"-":"")+"xxxx"+(c?"-":"")+"4xxx"+(c?"-":"")+"yxxx"+(c?"-":"")+"xxxxxxxxxxxx"+(d?"}":"")).replace(/[xy]/g,function(g){var f=Math.random()*16|0,e=g=="x"?f:(f&3|8);return e.toString(16)});return b.toUpperCase()},_appendParams:function(b,d){if(d.length!=0){var c=b;if(c.length!=0){if(c.indexOf("?")<0&&d.charAt(0)!="?"){c+="?"}else{if(d.charAt(0)!="?"){c+="&"}}}c+=d;return c}return b},_appendParam:function(b,d,e){if(d.length!=0){var c=b;if(c.indexOf("?")<0){c+="?"}else{c+="&"}c+=d+"="+e;return c}return b},_setOption:function(b,c){switch(b){}a.Widget.prototype._setOption.apply(this,arguments)},destroy:function(){a("button",this.element).off("click.inline-preview.button");if(this.previewImage!=null){this.previewImage.off("click.inline-previe-image")}this.element.empty();a.Widget.prototype.destroy.call(this)}})})(jQuery);